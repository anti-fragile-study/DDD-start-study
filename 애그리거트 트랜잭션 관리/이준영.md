# 애그리거트 트랜잭션 관리
## 선점 잠금(Pessimistic Lock)
선점잠금은 DBMS 테이블 혹은 칼럼에 락을 획득함으로써 다른 커넥션이 락을 얻지 못하도록 하는 기법이다.   
선점 잠금을 얻음으로써, 갱신 손실문제를 해결할 수 있으며 MySQL, 오라클과 같은 DBMS에서는 `select ... for update` 와 같이 쿼리를 작성함으로써 잠금을 얻을 수 있다.   
   
Spring Data JPA에서는 다음과 같이 `@Lock(LockModeType.PESSIMISTIC_LOCK)` 어노테이션을 통해서 얻을 수 있다.   
``` Java
public interface UserRepository extends JpaRepository<User, Long> {
  @Lock(LockModeType.PESSIMISITC_WRITE)
  Optional<User> findById(Long id)
}
```
   
선점 잠금을 사용할때는 교착상태 (Dead Lock) 이 발생하지 않도록 주의해야한다.   
예를들어, Thread-1 과 Thread-2가 자원 1, 2에 대해서 각각 선점 잠금을 한 뒤에, 반대쪽 자원에 대해서 잠금을 얻으려고 하면, 교착상태에 빠지게 된다.   
따라서, 선점잠금을 사용할때는 사용하는 DBMS가 교착상태를 어떻게 해제하는지 반드시 알아야하며, (MySQL 같은 경우 효율적인 동작을 위해 교착상태에 빠진 트랜잭션중 undo log양이 더 적은 트랜잭션을 롤백 시킨다.) 적당한 대기시간을 설정하는것이 중요하다.   

## 비선점 잠금(Optimisitic Lock)
