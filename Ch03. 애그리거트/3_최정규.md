# Ch03. 애그리거트

## 애그리거트

- 개별 구성요소 위주로 모델을 이해하면 전반적인 구조나 큰 수준에서 도메인 간의 관계를 파악하기 어려워진다.
- 주요 도메인 요소 간의 관계를 파악하기 어렵다는 것은 코드를 변경하고 확장하는 것이 어려워진다는 것을 의미한다.
- 전체 모델에 대한 이해가 부족하여 코드 변경을 회피하는 쪽으로 요구 사항을 협의하게 되고, 장기적으로 코드를 수정하기 힘들게 만든다.
- 애그리거트는 관련된 객체를 하나의 군으로 묶어줌으로써 상위 수준에서 도메인 모델 간의 관계를 파악할 수 있도록 한다.
- 애그리거트 단위로 일관성을 관리하기 때문에 복잡한 도메인을 단순한 구조로 만들어준다.
- 관련된 모델을 하나로 묶은 애그리거트에 속한 객체는 유사하거나 동일한 라이프 사이클을 갖는다.
- 함께 변경되는 빈도가 높은 객체는 한 애그리거트에 속할 가능성이 높다.
- A가 B를 갖는다는 요구사항이 항상 A와 B가 하나의 애그리거트에 속한다를 의미하는 것은 아니다.
    - 상품과 리뷰는 하나의 애그리거트가 아니다.
    - 상품이 생성될 때 리뷰가 생성되지 않고 함께 변경되지도 않는다.
    - 상품을 변경하는 주체는 어드민이고 리뷰를 생성하고 변경하는 주체는 고객이다.
- 처음 도메인 모델을 만들기 시작하면 큰 애그리거트로 보이는 것들이 많지만 도메인에 대한 이해가 깊어질수록 애그리거트의 크기는 줄어든다. 다수의 애그리거트가 대부분 한 개의 엔티티를 가지며 두 개 이상의 엔티티로 구성되는 애그리거트는 드물었다.

## 애그리거트 루트

- 도메인 규칙을 지키려면 애그리거트에 속한 모든 객체가 정상 상태를 가져야 한다.
    - 이를 위해 애그리거트 전체를 관리할 주체가 필요하다. → 루트 엔티티
    - 애그리거트에 속한 객체는 애그리거트 루트 엔티티에 직접 또는 간접적으로 속하게 된다.
- 루트 애그리거트의 역할
    - 애그리거트에 속한 객체를 직접 또는 간접적으로 포함
    - 애그리거트가 제공해야 할 도메인 기능을 일관성을 보장하며 구현
- 루트 애그리거트가 아닌 경로로 도메인 로직을 수행할 경우 논리적인 데이터의 일관성이 깨질 수 있고 관련 로직들이 중복으로 구현될 수도 있다.
- 루트 애그리거트를 통해서만 도메인 로직을 구현하게 만드는 방법
    - setter 메서드를 public으로 하지 않는다. → 도메인 로직을 한 곳에 응집시키기 위하여 (setter가 이곳저곳에서 남발되지 않고 애그리거트 내에서만 사용되도록)
    - 밸류 타입은 불변으로 구현한다. → 애그리거트 외부에서 내부 상태를 함부로 바꾸지 못하도록 방지
- 루트 애그리거트는 구성 요소의 상태를 참조하여 도메인 로직을 수행하거나 도메인 로직을 위임할 수도 있다.
- 제약사항으로 인해 불변 객체를 구현할 수 없다면 객체 상태를 변경하는 기능을 protected나 default로 한정해서 외부에서 실행할 수 없도록 제한할 수 있다. 한 애그리거트에 속하는 모델은 한 패키지에 속하기에 가능하다.
- 하나의 트랜잭션에서는 한 개의 애그리거트만 수정해야한다.
    - 처리하는 애그리거트가 많아질 수록 락의 범위가 커져 전체 처리량이 줄어들기 때문이다.
    - 두 개 이상의 애그리거트를 수정하는 경우 애그리거트에서 수정하는 것이 아니라 응용 서비스에서 수정해야한다.
        - 애그리거트 내부에서 다른 애그리거트의 상태를 변경할 경우 애그리거트의 책임 범위가 다른 애그리거트의 상태관리까지 포함하게 된다. 이는 애그리거트의 독립성을 떨어트리고 의존하게 되어 결합도가 높아진다.
    - 한 트랜잭션에서 한 개의 애그리거트를 수정하면서 다른 애그리거트의 상태를 변경하는 방법

      → 도메인 이벤트

    - 한 트랜잭션에서 두 개 이상의 애그리거트 변경하는 경우
        - 팀 표준: 사용자 유스케이스와 관련된 응용 서비스의 기능을 한 트랜잭션으로 실행하는 경우
        - 기술 제약: 기술적으로 이벤트 방식을 도입할 수 없는 경우 한 트랜잭션에서 다수의 애그리거트를 수정해서 일관성을 처리
        - UI 구현의 편리: 어드민의 편리함을 위해 여러 주문 상태를 한 번에 변경하는 경우
